<!DOCTYPE html>
<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:p="http://primefaces.org/ui"
>

<ui:composition template="/templates/template.xhtml">
    <ui:define name="title">Nya.GG - Admin Panel</ui:define>
    <ui:define name="heading">Admin Panel</ui:define>
    <ui:define name="content">

        <div class="mb-5">
            <p:linkButton outcome="/home.xhtml"
                          styleClass="ui-button-secondary">
                <i class="pi pi-arrow-left"/> Back to Home
            </p:linkButton>
        </div>

        <p:panel id="usersPanel" header="User Management">
            <p:messages id="messages" globalOnly="true" autoUpdate="true"/>
            <p:outputLabel value="Loaded #{adminBean.users.size()} of #{adminBean.totalUserCount} users"/>
            <h:form id="userManagementForm">
                <input type="hidden" name="_csrf" value="#{_csrf.token}"/>
                <p:dataTable value="#{adminBean.users}" var="user" styleClass="my-3" scrollable="true"
                             scrollHeight="#{facesContext.messageList.size() == 0 ? '50vh' : '40vh'}">
                    <p:column headerText="ID" width="10%">
                        <h:outputText value="#{user.id}"/>
                    </p:column>

                    <p:column headerText="Username" width="20%">
                        <h:outputText value="#{user.username}"/>
                    </p:column>

                    <p:column headerText="Current Roles" width="35%">
                        <p:outputPanel rendered="#{not empty adminBean.getCurrentUserRoles(user)}">
                            <p:panelGrid columns="1" layout="grid" styleClass="ui-panelgrid-blank ui-fluid">
                                <p:selectOneMenu value="#{adminBean.selectedRolesToRemove[user]}"
                                                 styleClass="w-100">
                                    <f:selectItems value="#{adminBean.getCurrentUserRoles(user)}"/>
                                </p:selectOneMenu>
                                <p:commandButton
                                        value="Remove"
                                        action="#{adminBean.removeRole(user)}"
                                        update="@form :messages"
                                        styleClass="ui-button-danger"
                                />
                            </p:panelGrid>
                        </p:outputPanel>
                        <h:outputText
                                value="User has no roles"
                                rendered="#{empty adminBean.getCurrentUserRoles(user)}"
                                styleClass="text-muted"
                        />
                    </p:column>

                    <p:column headerText="Add Role" width="35%">
                        <p:outputPanel
                                rendered="#{adminBean.getCurrentUserRoles(user).size() != adminBean.roles.size()}">
                            <p:panelGrid columns="1" layout="grid" styleClass="ui-panelgrid-blank ui-fluid">
                                <p:selectOneMenu value="#{adminBean.selectedRolesToAdd[user]}" styleClass="w-100">
                                    <f:selectItems value="#{adminBean.getAvailableUserRoles(user)}"/>
                                </p:selectOneMenu>
                                <p:commandButton
                                        value="Add"
                                        action="#{adminBean.addRole(user)}"
                                        update="@form :messages"
                                />
                            </p:panelGrid>
                        </p:outputPanel>
                        <h:outputText
                                value="User has all roles"
                                rendered="#{adminBean.getCurrentUserRoles(user).size() == adminBean.roles.size()}"
                                styleClass="text-muted"
                        />
                    </p:column>
                </p:dataTable>

                <p:commandButton
                        value="Load More Users"
                        action="#{adminBean.loadMoreUsers}"
                        update=":usersPanel"
                        disabled="#{!adminBean.hasMoreUsers}"
                        styleClass="ui-button-secondary"
                        oncomplete="$('.ui-datatable-scrollable-body').scrollTop(100000);"
                />
            </h:form>
        </p:panel>

    </ui:define>
</ui:composition>
</html>