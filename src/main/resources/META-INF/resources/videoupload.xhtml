<!DOCTYPE html>
<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:p="http://primefaces.org/ui"
        xmlns:h="http://xmlns.jcp.org/jsf/html"
>
<ui:composition template="/templates/template.xhtml">
    <ui:define name="title">Nya.GG - Video Upload</ui:define>
    <ui:define name="heading">Video Upload</ui:define>
    <ui:define name="head">
        <h:outputStylesheet name="/assets/css/trimmer.css"/>
    </ui:define>
    <ui:define name="content">
        <div class="my-3">
            <p:linkButton outcome="/home.xhtml"
                          styleClass="ui-button ui-button-secondary no-underline">
                <i class="pi pi-arrow-left"/> Back to Home
            </p:linkButton>
        </div>

        <!-- File input to select local video -->
        <form id="videoForm" action="/v/" method="post" enctype="multipart/form-data">
            <label for="videoInput">Choose a video file:</label>
            <input type="file" id="videoInput" name="videoInput" accept="video/*" />
            <input type="hidden" id="startTimeSeconds" name="startTimeSeconds" />
            <input type="hidden" id="endTimeSeconds" name="endTimeSeconds" />
            <input type="hidden" name="_csrf" value="${_csrf.token}" />
        </form>

        <div class="trimmer-container">
            <video id="videoPlayer" preload="auto" width="640" height="360">
                <source id="videoSource" src="" type="" />
                Your browser does not support the video tag.
            </video>

            <h2>Video Trimmer</h2>

            <div class="trimmer-bar" id="trimmerBar">
                <div class="timeline">
                    <div class="timeline-markers" id="timelineMarkers"></div>
                </div>
                <div class="progress-bar" id="progressBar"></div>
                <div class="trimmer-handle handle-left" id="leftHandle"></div>
                <div class="trimmer-handle handle-right" id="rightHandle"></div>
                <div class="position-indicator" id="positionIndicator"></div>
            </div>

            <div class="time-display">
                <div>Start: <span id="startTime">0:00</span></div>
                <div><strong>Selected Duration: <span id="selectedDuration">1:00</span></strong></div>
                <div>End: <span id="endTime">1:00</span></div>
            </div>

            <button id="trimButton" class="btn btn-primary">Trim And Upload</button>
        </div>

        <!-- Script to handle file input -->
        <script>
            let trimmer = null;
            
            document.getElementById('videoInput').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const video = document.getElementById('videoPlayer');
                    const source = document.getElementById('videoSource');

                    source.src = URL.createObjectURL(file);
                    source.type = file.type;

                    video.addEventListener('loadedmetadata', function() {
                        const duration = video.duration;
                        trimmer = new VideoTrimmer(duration);
                    });

                    video.load(); // Load new video source
                    video.play(); // Optional: autoplay
                }
            });
            
            // Handle trim button click
            document.getElementById('trimButton').addEventListener('click', function(e) {
                e.preventDefault();
                
                if (!trimmer) {
                    alert('Please select a video file first.');
                    return;
                }
                
                // Set the hidden fields with current trimmer values
                document.getElementById('startTimeSeconds').value = trimmer.startTime;
                document.getElementById('endTimeSeconds').value = trimmer.endTime;
                
                // Submit the form
                document.getElementById('videoForm').submit();
            });
        </script>

        <h:outputScript name="/assets/js/trimmer.js"/>
    </ui:define>

</ui:composition>
</html>
